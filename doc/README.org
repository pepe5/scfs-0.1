# -*- org -*-
* Streaming fevent/s collector

# Hi-lock: (("\\$> .*" (0 (quote hi-red-b) t)))
# Hi-lock: (("\\#> .*\\|;\\#" (0 (quote font-lock-comment-face) t)))
# Hi-lock: (("'[^']+'\\|\"[^\"]+\"" (0 (quote font-lock-string-face) t))) ;"


* TODO
** rework @ [[file:/home/kraljo/text/my-confs/doc/readme.org::sclocate-import.pl%20|%20pv%20|%20sqlite3%20$F.sqlite][sclocate-import.pl | pv | sqlite3 $F.sqlite]]
*** entry stat:> echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
cd $FS
F=$(df -hP | egrep " `pwd`$" | cut -d\  -f1 | xargs basename)@`uname -n`,`date -Id`; echo F:$F
mv -vbf $F.sqlite{,~}
find . -xdev -type f -printf "%i %k %M %n %u %g %s %TY-%Tm-%Td %TH:%TM:%TS %h/%f\n" | ~/bin/sclocate-import.pl | pv | sqlite3 $F.sqlite
ls -ldht `pwd`/*@*.sqlite* `pwd`/$F.sqlite | sort -t@ -k2r -u
echo; done
**** $> echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
cd $FS
F=$(df -hP | egrep " `pwd`$" | cut -d\  -f1 | xargs basename)@`uname -n`,`date -Id`; echo F:$F
cat <<EOF | sqlite3 $F.sqlite
CREATE INDEX "find_printf_inode" ON find_printf (inode ASC);
CREATE INDEX "find_printf_s" ON find_printf (s ASC);
CREATE INDEX "find_printf_mtime" ON find_printf (mtime ASC);
CREATE INDEX "find_printf_dir" ON find_printf (dir ASC);
CREATE INDEX "find_printf_fn" ON find_printf (fn ASC);
EOF
ls -ldht `pwd`/*@*.sqlite* `pwd`/$F.sqlite | sort -t@ -k2r -u
echo; done

*** file:~/text/scfs/lib/sclocate-import.pl

*** TODO gen [[fs-id]]/s ~ in py> product('ABCD', repeat=2) #> AA AB AC AD BA BB BC BD CA CB CC CD DA DB DC DD
    - >? http://stackoverflow.com/questions/8242972/is-there-anything-like-python-itertools-in-perl

*** ( :43_time: ) $> FSs=`mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | xargs echo`; echo FSs:$FSs
    - $> eval ls -ld {`echo $FSs | perl -pe 's/ /,/g'`}/*@*.sqlite

*** $> rsync -abvP -e 'ssh -l sam' 10.0.0.189:/media/sam/*/*15.sqlite /mnt/lifeboat-tmp/
*** $> S=sierra; echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
cd $FS; ls -ldh `pwd`/*@*.sqlite
sqlite3 `ls -1t *@*.sqlite | head -1` "SELECT * FROM find_printf WHERE fn LIKE '$S%' LIMIT 10"
echo; done

**** :ARCHIVE: $> S=sierra; echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
cd $FS; ls -ldh `pwd`/*@*.sqlite
sqlite3 *@*.sqlite "SELECT * FROM find_ls WHERE fts4 MATCH '$S*' LIMIT 10"
echo; done

*** S> SELECT * FROM find_printf WHERE ix=(SELECT Max (ix) FROM find_printf); # +
**** S> SELECT s, count(s) as scnt
                    FROM find_printf
                    WHERE s <> 0
                    GROUP BY s
                    ORDER BY scnt DESC
                    LIMIT 10;
**** #> <2014-01-27 Mon>
     ...>    ...>    ...>    ...> 
     8192|1621
     834|1555
     10645|1156
     10596|1036
     1527|624
     10674|616
     10620|569
     15360|450
     828|417
     1830|410
     ..

**** S> sqlite> SELECT fn, count(s) as ncnt
                    FROM find_printf
                    GROUP BY fn
                    ORDER BY ncnt DESC
                    LIMIT 10;
**** #> <2014-01-27 Mon>
     ...>    ...>    ...>    ...> 
     index.html|53110
     django.po|3748
     django.mo|3638
     __init__.py|1424
     __init__.pyc|1296
     %gconf.xml|777
     EmoticonHappy.gif|588
     djangojs.mo|354
     djangojs.po|354
     README|341

** use -xdev
** function sclocate \
   { echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
       cd $FS; ls -ldh `pwd`/*@*.sqlite
       sqlite3 `ls -1t *@*.sqlite | head -1` "SELECT * FROM find_printf WHERE fn LIKE '$1%' LIMIT 10"
       echo;
   done; }

*** ALTER TABLE find_printf ADD COLUMN md5 TEXT:
**** #> echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
         cd $FS; ls -1dht `pwd`/*@*[0-9].sqlite | head -1
     done | while read CAT; do
	 ls -ldh "$CAT"
	 sqlite3 "$CAT" "ALTER TABLE find_printf ADD COLUMN md5 TEXT"
     done

*** ALTER TABLE find_printf ADD COLUMN ut TEXT

** /random sync/ - CAT originated
   - if last rec. doesnt match actual finding, -> append refresh

** TODO deduplicate by hard-links (-xdev)
*** $> echo; mount | perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
        cd $FS; ls -1dht `pwd`/*@*[0-9].sqlite | head -1
    done | egrep '@oc.*-15' | while read CAT; do 
        L=$(sqlite3 $CAT "SELECT s,fn FROM find_printf LIMIT 1")
        S=${L%%|*}
        F=${L##*|}
        echo $CAT: -S:$S -F: $F
    done

*** $> DIR=$HOME/Desktop
       $> FN=eng.org
       $> ls -l "$DIR/$FN"
       -rw-rw-r--. 1 kraljo kraljo 295916 Jan 24 15:18 /home/kraljo/Desktop/eng.org

       $> CAT=//vg_ocrh63-lv_root@oc0653706537.ibm.com,2014-01-15.sqlite
       $> echo; sqlite3 "$CAT" "
                             SELECT inode,du,perms,lns,s,mtime,dir,fn
                             FROM find_printf
                             WHERE fn = '$FN'
                             LIMIT 10" \
                         | perl -nle '
                             @A=split /\|/;
                             print join (" ",@A[0..3])." - - ".join (" ",@A[4..$#A-1])."$A[$#A]"'
       > > > > > > > 
       657721 288 -rw-rw-r-- 1 - - 294454 2014-01-15 10:52:17 ./home/kraljo/Desktop/eng.org

       $> find "$DIR/$FN" -type f -printf "%i %k %M %n - - %s %TY-%Tm-%Td %TH:%TM:%TS %h/%f\n" | perl -pe 's/([\d-]+\s+[\d:]+)\.\d+/$1/'
       657718 292 -rw-rw-r-- 1 - - 295916 2014-01-24 15:18:23 /home/kraljo/Desktop/eng.org

*** S> SELECT scnt, f.* FROM find_printf f CROSS JOIN
( SELECT s, count(s) as scnt
    FROM find_printf
    WHERE s <> 0
    GROUP BY s
    ) c
ON c.s = f.s
ORDER BY scnt DESC
LIMIT 10;
**** #> <2014-01-27 Mon>
   ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...> 
1621|3239|2014-01-15 14:40:23|5386221|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c4f1.dat|
1621|3240|2014-01-15 14:40:23|5386155|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c101.dat|
1621|3241|2014-01-15 14:40:23|5386200|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c3b1.dat|
1621|3242|2014-01-15 14:40:23|5386172|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c200.dat|
1621|3243|2014-01-15 14:40:23|5386195|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c361.dat|
1621|3244|2014-01-15 14:40:23|5386236|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|cd1.dat|
1621|3245|2014-01-15 14:40:23|5386237|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|ce1.dat|
1621|3248|2014-01-15 14:40:23|5386231|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c81.dat|
1621|3250|2014-01-15 14:40:23|5386213|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c471.dat|
1621|3252|2014-01-15 14:40:23|5386168|8|-rwxr-xr-x|1|kraljo guest|8192|2011-11-11 10:22:55|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c1d1.dat|

*** S> SELECT scnt, f.s, ncnt, f.fn, f.* FROM find_printf f 
CROSS JOIN
( SELECT s, count(s) as scnt
    FROM find_printf
    WHERE s <> 0
    GROUP BY s
    ) sc ON sc.s = f.s
CROSS JOIN
( SELECT fn, count(fn) as ncnt
    FROM find_printf
    GROUP BY fn
    ) nc ON nc.fn = f.fn
ORDER BY scnt DESC, fn
LIMIT 10;

**** <2014-01-29 Wed>
   ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...>    ...> 
1621|8192|2|Daily restart of BEA instance eInvestor_Maestro_Scheduler_v1.xls|207588|2014-01-15 14:41:41|5114049|8|-rwxrwx---|1|kraljo guest|8192|2008-10-22 18:36:16|./kraljo/Downloads/4-ibm/gsa/03_EuC_Spain/Maestro job specifications/|Daily restart of BEA instance eInvestor_Maestro_Scheduler_v1.xls|
1621|8192|2|Daily restart of BEA instance eInvestor_Maestro_Scheduler_v1.xls|276867|2014-01-15 14:41:47|134018|8|-rwxrwx---|1|kraljo guest|8192|2008-10-22 18:36:16|./kraljo/Downloads/4-ibm/gsa~poluted/03_EuC_Spain/Maestro job specifications/|Daily restart of BEA instance eInvestor_Maestro_Scheduler_v1.xls|
1621|8192|2|IEExecRemote.dll|278330|2014-01-15 14:41:47|5512974|8|-rw-rw-r--|1|kraljo guest|8192|2005-09-23 08:28:56|./kraljo/.wine/drive_c/windows/Microsoft.NET/Framework/v2.0.50727/|IEExecRemote.dll|
1621|8192|2|IEExecRemote.dll|278665|2014-01-15 14:41:47|5643297|8|-rw-rw-r--|1|kraljo guest|8192|2011-11-11 13:00:56|./kraljo/.wine/drive_c/windows/assembly/GAC_MSIL/IEExecRemote/2.0.0.0__b03f5f7f11d50a3a/|IEExecRemote.dll|
1621|8192|1|System.Drawing.tlb|278137|2014-01-15 14:41:47|5513028|8|-rw-rw-r--|1|kraljo guest|8192|2005-09-23 08:28:56|./kraljo/.wine/drive_c/windows/Microsoft.NET/Framework/v2.0.50727/|System.Drawing.tlb|
1621|8192|1|aspnet_isapi.dll|278392|2014-01-15 14:41:47|5513078|8|-rw-rw-r--|1|kraljo guest|8192|2005-09-23 08:28:32|./kraljo/.wine/drive_c/windows/Microsoft.NET/Framework/v2.0.50727/|aspnet_isapi.dll|
1621|8192|26|c10.dat|3291|2014-01-15 14:40:23|4724549|8|-rwxr-xr-x|1|kraljo guest|8192|2012-08-29 20:00:22|./kraljo/.ILC/ClientDatabase/LocalClaimDB/seg0/|c10.dat|
1621|8192|26|c10.dat|48099|2014-01-15 14:40:27|529566|8|-rw-rw-r--|1|kraljo guest|8192|2012-04-07 22:40:05|./kraljo/opt/magnolia-4.5.2/apache-tomcat-6.0.32/webapps/magnoliaAuthor/repositories/magnolia/workspaces/templates/db/seg0/|c10.dat|
1621|8192|26|c10.dat|48189|2014-01-15 14:40:27|525669|8|-rw-rw-r--|1|kraljo guest|8192|2012-04-07 22:44:18|./kraljo/opt/magnolia-4.5.2/apache-tomcat-6.0.32/webapps/magnoliaAuthor/repositories/magnolia/workspaces/mgnlSystem/db/seg0/|c10.dat|
1621|8192|26|c10.dat|48282|2014-01-15 14:40:27|529466|8|-rw-rw-r--|1|kraljo guest|8192|2012-04-07 22:39:59|./kraljo/opt/magnolia-4.5.2/apache-tomcat-6.0.32/webapps/magnoliaAuthor/repositories/magnolia/workspaces/dms/db/seg0/|c10.dat|

*** list f-ix/s of file/s w/ reoccurring size/s $> echo; mount \
| perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
    cd $FS; ls -1dht `pwd`/*@*[0-9].sqlite | head -1
  done \
| egrep '@oc.*-15.sqlite' | while read CAT; do 
    sqlite3 "$CAT" "
        SELECT ix FROM find_printf f
        CROSS JOIN
        ( SELECT s, count(s) as scnt
            FROM find_printf
            WHERE s <> 0
            GROUP BY s
            ) sc ON sc.s = f.s
        CROSS JOIN
        ( SELECT fn, count(fn) as ncnt
            FROM find_printf
            GROUP BY fn
            ) nc ON nc.fn = f.fn
        ORDER BY scnt DESC, f.fn
        LIMIT 10" \
    | awk -v CAT=$CAT '{print $0":"CAT}'
  done | cat -n | tail

**** <2014-01-29 Wed>
> > > > > > > > > > > > > > > > > > > > 
    51	26271:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    52	26170:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    53	26004:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    54	26250:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    55	26090:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    56	25747:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    57	25809:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    58	25900:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    59	25748:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite
    60	25808:/mnt/lifeboat-tmp/vg_lifeboat-lv_tmp@oc0653706537.ibm.com,2014-01-15.sqlite

*** list ls-dils/s of file/s w/ reoccurring size/s $> echo; mount \
| perl -ne 'm{^/.* on (.*) type } and print "$1\n"' | while read FS; do
    cd $FS; ls -1dht `pwd`/*@*[0-9].sqlite | head -1
  done \
| while read CAT; do 
    sqlite3 "$CAT" "
            SELECT ix FROM find_printf f
            CROSS JOIN (SELECT s, count(s) as scnt FROM find_printf WHERE s <> 0 GROUP BY s) sc ON sc.s = f.s
            CROSS JOIN (SELECT fn, count(fn) as ncnt FROM find_printf GROUP BY fn) nc ON nc.fn = f.fn
            ORDER BY scnt DESC, f.fn
            LIMIT 100" \
        | awk -v CAT=$CAT '{print $0,CAT}'
  done \
| while read IX CAT; do
    LASTC=$(sqlite3 "$CAT" "
            SELECT inode,du,'-',lns,'-','-',s,mtime,dir,fn
            FROM find_printf f
            WHERE dir = (SELECT dir FROM find_printf WHERE ix=$IX)
            AND fn = (SELECT fn FROM find_printf WHERE ix=$IX)
            ORDER BY dt DESC
            LIMIT 1"\
        | perl -nle '
            @A=split /\|/;
            print join (" ",@A[0..$#A-1])."$A[$#A]"')
    S=`echo $LASTC | cut -d\  -f7`
    P=`echo $LASTC | cut -d\  -f10-`
    F=${P##*/}
    # echo " -|LASTC|: `echo $LASTC | wc -w`"
    if [[ 0 != `echo $LASTC | wc -w` ]]
    then
       LASTF=$(find 2>&1 "`dirname $CAT`/$P" \
                -type f \
                -printf "%i %k - %n - - %s %TY-%Tm-%Td %TH:%TM:%TS %h/%f\n" \
            | perl -pe 's/([\d-]+\s+[\d:]+)\.\d+/$1/')
        if [[ "`echo $LASTC | cut -d\  -f-9`" != "`echo $LASTF | cut -d\  -f-9`" ]];
        then
            echo
            echo $IX $CAT: '<>' # -S: $S -F:$F
            echo ' <-'$LASTC
            echo ' ->'$LASTF
        else echo -n .
        fi
    fi
done


*** phase-1: only if fname/s ==:
*** DONE :whatif: inode/s == -> skip - is DONE
*** TODO :whatif: last f doesnt exists -> upd w/ ut (unliked recognition time)
*** TODO :whatif: size/s <> -> make refresh
*** TODO :whatif: else (inode/s <>, but size/s ==) -> make refresh w/ md5 sum

*** TODO phase-2: even for fname/s <>..

** new model:
**** 1 [[fvlocation]] :: id/ed by (key): location fname, location dirname, mtime, [[fs-id]]
**** redundant data > [[fvlocation]] dependent:
***** fs data ~> size, x-time/s, fs-based perm/s, ..

**** 1 [[fversion]] :: id/ed by "content check/s authenticity":
***** analysis ~> sum, other analysis, ..

**** redundant data > [[fversion]] - content dependent:
***** db-own data ~> use, purpose perm/s


***** [[fversion]]/s can be grouped to [[File-tree]]
      - which is obj. /Class/ (prototype) - not content /instance/


**** redundant data > every-time calculated:
***** [[fversion]] HA ~> mirrors#, age of cache/s, accessibility stat/s
***** [[fversion]] SYNChronicity ~> if it is head of [[File-tree]]

** basic cmd/s:
*** find-cats
*** find-id <file> [ --in <cat> ]
    - foreach-> CAT/* (listed by [[find-cats]])
    - list /actual/ rec for <file> from all CAT/s

*** upd-rec <file>
    - upd. /actual/ rec. -- if it exists || create one
**** it should work ~ this:
     1. get Actual-candidate (A1=1, A2=2, A3=3, A4='')
     2. get Last-record (L1=1, L2=2, L3='', L4=4)
     3. only iff all filled L-field/s (L/s) are == (to counterparts) -> fill rest (empty) L/s w/ non-empty A/s
     4. otherwise make new Last-rec (& previous one deactivate by utime)


** print " -makedirs exception: %s" % err >> test exception instead
   + mountPoint = userPoint --> addPoint = userPoint
** move Cdcatfs (Case Conflict 1)
   (that symln -> /usr/local/lib/python2.6/dist-packages/Cdcatfs)
   to other place than cdcatfs exe
   <= Dropbox rename it - is not case sensitive

** make it [[pydoc]]
** add Config
** test w/ http://ivory.idyll.org/articles/nose-intro.html#test-fixtures
*** scfs> nosetests -v lib/ --collect-only
*** scfs> nosetests -v lib/ # :ARCHIVE: #
    test_nose.test_uc1 ... ok
    ----------------------------------------------------------------------
    Ran 1 test in 0.004s
    OK


** [#B] 
*** @contextmanager; def [[http://groups.google.com/group/paver/browse_thread/thread/90434e3338e15796%3Fpli%3D1][pushd]](dir)


* ACT INTRO
** fresh os inst howto
   - basically you have root (-/) fs of files from os inst &
     all other (--customized) files have to go to /{mnt|media}/vol-name/
*** so on root fs you will have
    - minimal inst-pkg/s file/s
    - (rest of) initial inst-pkg/s file/s
    - added-pkg/s files
    - (added) app-generated cache/s
    - mount-point/s to real data-store/s
    - file-link/s replacements instead of files which you customized
    - dir-link/s replacements of dir/s which where empty & you want them fill

** ~/bin/ls needs
*** one-elements file-spec in ARGV now (<2014-01-18 Sat>)
*** -I'*~' in dired-listing-switches
    (dired-listing-switches "--group-directories-first --time-style=long-iso -I'*~' -l")


** dev act/s file:../lib/tests/test_nose.py
*** [[dev env depl]]
    - $> rm -vr /tmp/dev/scwd/* ~/.scfs/cat1.sqlite; nosetests -v lib/

*** TODO why scfs> find ~/mnt/cat1/WD_UC1 -ls # stops recursion??
    :tip: on ubuntu it works ok, so this (vv) is only aspire1 fc 

**** output
    5    0 drwxr-xr-x   2 root     root            0 led  1  1970 /home/user/mnt/cat1/WD_UC1
    6    0 drwxr-xr-x   2 user     user           80 kvě 18 07:36 /home/user/mnt/cat1/WD_UC1/a
    7    0 drwxr-xr-x   2 user     user           60 kvě 18 07:36 /home/user/mnt/cat1/WD_UC1/b

    scfs> sudo find ~/mnt/cat1/WD_UC1/a -ls
    6    0 drwxr-xr-x   2 user     user           80 kvě 18 07:36 /home/user/mnt/cat1/WD_UC1/a
    8    0 -rw-rw-r--   1 user     user          329 kvě 18 09:05 /home/user/mnt/cat1/WD_UC1/a/123
    9    0 -rw-rw-r--   1 user     user          329 kvě 18 09:05 /home/user/mnt/cat1/WD_UC1/a/321

** UC1 /def test_uc1/


* SETUP
** dev env depl (at $> cd ~/text/scfs/:)
*** TODO add this from context/s of: [[file:::/install%20-v%20-d%20/tmp/dev/scwd/][/install -v -d /tmp/dev/scwd/]]

*** RE/FRESH (tear down dev env)
**** $> rm -vr /tmp/dev/scwd/*
**** $> rm -vr ~/.scfs/cat1.sqlite

** INST (only 1st time)
*** linking to site-packages
     pushd /usr/lib/python2.5/site-packages/ && pakSite=`pwd` && popd
     pushd /usr/local/lib/python2.6/dist-packages/ && pakSite=`pwd` && popd
     pushd /usr/lib/python2.7/dist-packages/ && pakSite=`pwd` && popd
**** TODO >! distutil shall handle this!

**** $> PATH=$PATH:$HOME/text/scfs/lib

*** install fuse binding
**** TODO :STU: a8h if is there too ver.: ftp://ftp.pbone.net/mirror/archive.fedoraproject.org/fedora/linux/releases/11/Everything/x86_64/os/Packages/fuse-python-0.2-10.fc11.x86_64.rpm

*** install scfs module
**** $> sudo install -v -d $pakSite/Scfs
**** $> sudo touch $pakSite/Scfs/__init__.py
**** $> sudo ln -sv -bf `pwd`/lib/Cat*.py `pwd`/lib/Dir*.py $pakSite/Scfs/
**** $> sudo ln -sv -bf `pwd`/lib/scatfs $pakSite/Scfs/ScatServices.py
**** $> wget -O - http://ie.archive.ubuntu.com/download.sourceforge.net/pub/sourceforge/c/project/cd/cdcatfs/cdcatfs/0.1.5/cdcatfs-0.1.5.tar.gz | tar xzf - -O cdcatfs-0.1.5/src/Cdcatfs/utils.py | sudo tee $pakSite/Scfs/utils.py | wc
**** $> sudo ln -sv /usr/lib64/python2.4/site-packages/fuse* $pakSite
**** $> ln -sv `pwd`/lib/scat* ~/bin

*** opening .scfs personal repo
**** $> mkdir -v ~/.scfs/


* XATTR PART
** gvfs-info ~ info
   - $> (echo .mode line; echo "select * from WD_UC2_files where fileName = 'c1';") | sqlite3 ~/.scfs/cat1.cdcat
   - #> fid = 2
     pid = 1
     fileName = a
     st_mode = 16877
     st_nlink = 2
     st_uid = 1000
     st_gid = 1000
     st_size = 4096
     st_atime = 1341952183
     st_mtime = 1341952183
     st_ctime = 1341952183

** stu setup
   - [[xattr stu]]

** test, 2012-08-01 22:37:01, 6ef7af8
*** $> inotail -f /tmp/in | python -u lib/xattr-fill.py &
*** $> date -Is >> /tmp/in


* STU
** :whatif: new (sql) schema #> Error: table find_printf has 10 columns but 11 values were supplied
   - > cound file:../lib/sclocate-import.pl::/,$/
   - <2014-01-15 Wed> i missed ',' after /lns INTEGER/

** query iface grep-find~
   - $> find $d -type f | while read L; do echo '' -$L:; locate "$L" | awk '{print "\""$0"\""}' | xargs ls -dilt; done
*** :ARCHIVE:
   - $> find $d -type f | while read L; do echo '' -$L:; locate "$L" | while read F; do ls -lid "$F"; done; done

** xattr stu
   - $> setfattr -n user.do_i_own -v "YES" /tmp/dev/scwd/c1
   - $> gvfs-info /tmp/dev/scwd | grep xattr

** TODO fuse args
   server.parser.parse_args(['-o database=/home/user/.scfs/cat1.cdcat'])
   server.parse(values=server)

** print " -mounting to: %s" % Config.cdpoint

** import sqlite3 as sqlite #(<) from pysqlite2 import dbapi2 as sqlite
    CDLabel = 'WD_UC1'
    fileId = 6
    name = '123'
    con = sqlite.connect('/home/user/.scfs/cat1.cdcat')
    cmd = ("SELECT fid ,pid ,fileName, st_mode, count_name, st_uid, st_gid, st_size, st_atime, st_mtime, st_ctime " +
                           "FROM %s_files " +
                           "JOIN (SELECT fileName, COUNT(fileName) AS count_name FROM %s_files WHERE fileName='%s') AS Tbl2 " +
                           "ON %s_files.fileName = Tbl2.fileName " +
    			   "WHERE fid =%d;") \
                        % (CDLabel, CDLabel, name, CDLabel, fileId)
    rows = con.cursor().execute(cmd).fetchall()
    rows

**** SELECT fid, pid, WD_UC1_files.fileName, st_nlink, Tbl2.count_name
    FROM WD_UC1_files
    JOIN (SELECT fileName, COUNT(fileName) AS count_name FROM WD_UC1_files WHERE fileName='123')
    AS Tbl2
    ON WD_UC1_files.fileName = Tbl2.fileName;


** :last: scfs> nosetests lib/ -v # <2011-05-14 Sat>
    Use case 1 ... FAIL
    ======================================================================
    FAIL: Use case 1
    ----------------------------------------------------------------------
    Traceback (most recent call last):
    File "/usr/lib/pymodules/python2.6/nose/case.py", line 183, in runTest
    self.test(*self.arg)
    File "/home/p-b/text/scfs/lib/tests/test_nose.py", line 48, in test_uc1
    assert f123['st_nlink'] == 2
    AssertionError: 
    -------------------- >> begin captured stdout << ---------------------
    -mounting to: ~/mnt/cat1
    -registering (blind dir) at: /tmp/scwd
    -capturing wd state: 
    <subprocess.Popen object at 0x87c9aac>
    --------------------- >> end captured stdout << ----------------------

    ----------------------------------------------------------------------
    Ran 1 test in 0.018s

    FAILED (failures=1)
    790854    4 -rw-r--r--   1 p-b      p-b             3 May 14 23:22 ./b/123
    790853    4 -rw-r--r--   1 p-b      p-b             3 May 14 23:22 ./a/321
    790852    4 -rw-r--r--   1 p-b      p-b             3 May 14 23:22 ./a/123


* DONE
** separate cdcat & scat file holders
   [[file:~/text/scfs/lib/scatfs::/from%20Cdcatfs.utils%20import%20CacheDict/][scatfs::/from *Cdcatfs*.utils import CacheDict/]]
** subprocess.Popen repr differs in py25 & py26 ?!
   -cleaning wd table: <subprocess.Popen object at 0xb7aceb8c>
   -> DONE by pop = subprocess.Popen(shlex.split(cmd), stdout=subprocess.PIPE)
    print " -cleaning wd table: %s" % pop.communicate() ...

** i got 2 traceback/s in 1 tc, <2011-05-18 St>
   -> DONE by expanduser on Config.db
   <= it is from cdcatman xy subprocess/es

*** 2nd one:
   Traceback (most recent call last):
   ----------------------------------------------------------------------
   File "/usr/bin/cdcatman", line 87, in <module>
   catCreator = CatalogCreator(dbFile, mountPoint, CDLabel)
   File "/usr/lib/python2.5/site-packages/Cdcatfs/CatalogCreator.py", line 32, in __init__
   self.__initDb();
   File "/usr/lib/python2.5/site-packages/Cdcatfs/CatalogCreator.py", line 60, in __initDb
   con = sqlite.connect(self.__dbFile)
   pysqlite2.dbapi2.OperationalError: unable to open database file



* :ARCHIVE: OLD
** longest common:
   self.__mountPoint = []
   [[file:~/text/scfs/lib/CatalogCreator.py::/for%20name%20in%20pathComponents/][for name in pathComponents]]

** <<UC1>> health-check
*** scfs> nosetests lib/ -v
    Use case 1 ... /usr/bin/find: error while loading shared libraries: libselinux.so.1: cannot read file data: Error 21
    ok
    ----------------------------------------------------------------------
    Ran 1 test in 0.426s
    OK


** <<UC2>> insert (that simplest one)
*** design: cp -r  /tmp/dev/scwd  /tmp/dev/scwd2
    python lib/scatman del WD_UC2 ~/.scfs/cat1.cdcat
    python lib/scatman add /tmp/dev/scwd WD_UC2 ~/.scfs/cat1.cdcat
    echo 234 > /tmp/dev/scwd/b/234
    python lib/scatman add /tmp/dev/scwd/b WD_UC2 ~/.scfs/cat1.cdcat

*** setup
    :cleanup: rm -vr /tmp/dev/scwd/b/bb
    scatman d WD_2 ~/.scfs/cat1.cdcat
    
    :setup: scfs> scatman add /tmp/dev/scwd/ WD_2 ~/.scfs/cat1.cdcat
    scfs> sqlite3 ~/.scfs/cat1.cdcat 'select * from WD_2_files'
    1|0||16877|4|1000|1000|4096|1305837230|1305836661|1305836661
    2|1|b|16877|2|1000|1000|4096|1305847964|1305851133|1305851133
    3|1|a|16877|2|1000|1000|4096|1305838778|1305838705|1305838705
    4|3|321|33188|1|1000|1000|3|1305844485|1305839794|1305839794
    5|3|123|33188|1|1000|1000|3|1305838705|1305839794|1305839794
    6|2|123|33188|1|1000|1000|3|1305838705|1305839794|1305839794

    scfs> 
    install -v -d /tmp/dev/scwd/b/bb /tmp/dev/scwd/b/bb/bbb
    install -v /tmp/dev/scwd/a/321 /tmp/dev/scwd/b/bb
    echo > /tmp/dev/scwd/b/bb/bbb/234
    scfs> install: creating directory `/tmp/dev/scwd/b/bb'
    install: creating directory `/tmp/dev/scwd/b/bb/bbb'
    scfs> `/tmp/dev/scwd/a/321' -> `/tmp/dev/scwd/b/bb/321'

    :act: scfs> scatman add /tmp/dev/scwd/b/bb/ WD_2 ~/.scfs/cat1.cdcat
    Label exists. Trying add onto existing mountPoint
    - from (common) -mountPoint: /tmp/dev/scwd
      -name< b, -pid: 1
      -common?> (fid:) 2 (hops -> 1)
      -name< bb, -pid: 2
      -last-id from common part: 2
      -startPoint: ['bb']
      Traceback (most recent call last):
      File "/usr/local/bin/scatman", line 88, in <module>
      catCreator = CatalogCreator(dbFile, mountPoint, CDLabel)
      File "/usr/local/lib/python2.6/dist-packages/Scfs/CatalogCreator.py", line 33, in __init__
      self.__initDb();
      File "/usr/local/lib/python2.6/dist-packages/Scfs/CatalogCreator.py", line 109, in __initDb
      raise NotImplementedError
      NotImplementedError

*** 1st pass (<2011-05-20 Fri>):
    scfs> find ~/mnt/cat1/ -ls
    1    0 drwxr-xr-x   2 root     root            0 Jan  1  1970 /home/p-b/mnt/cat1/
    4    0 drwxr-xr-x   2 root     root            0 Jan  1  1970 /home/p-b/mnt/cat1/WD_2
    8    0 drwxr-xr-x   1 p-b      p-b          4096 May 19 22:58 /home/p-b/mnt/cat1/WD_2/a
    9    0 -rw-r--r--   2 p-b      p-b             3 May 19 23:16 /home/p-b/mnt/cat1/WD_2/a/123
    10    0 -rw-r--r--   2 p-b      p-b             3 May 19 23:16 /home/p-b/mnt/cat1/WD_2/a/321
    11    0 drwxr-xr-x   1 p-b      p-b          4096 May 20 04:02 /home/p-b/mnt/cat1/WD_2/b
    12    0 -rw-r--r--   2 p-b      p-b             3 May 19 23:16 /home/p-b/mnt/cat1/WD_2/b/123
    13    0 drwxr-xr-x   1 p-b      p-b          4096 May 20 04:02 /home/p-b/mnt/cat1/WD_2/b/bb
    14    0 -rwxr-xr-x   2 p-b      p-b             3 May 20 04:02 /home/p-b/mnt/cat1/WD_2/b/bb/321
    15    0 drwxr-xr-x   1 p-b      p-b          4096 May 20 04:02 /home/p-b/mnt/cat1/WD_2/b/bb/bbb
    16    0 -rw-r--r--   1 p-b      p-b             1 May 20 04:02 /home/p-b/mnt/cat1/WD_2/b/bb/bbb/234

*** from Scfs.DirectoryWalker import DirectoryWalker
for (fname,stats,fileId,parentId) in DirectoryWalker ('/tmp/dev/scwd',
    {'parentId':2, 'lastId':6, 'startAbs':'/tmp/dev/scwd/b/bb'}):
  print fileId, parentId, fname

<<
   from Scfs.DirectoryWalker import DirectoryWalker
   for (fname,stats,fileId,parentId) in DirectoryWalker ('/tmp/dev/scwd/'):
     print fname, fileId, parentId

*** scfs$> python doc/stu/DirectoryWalker-1.py /tmp/dev/scwd/
    -argv: ['/tmp/stu.py', '/tmp/dev/scwd/a/']
    -wd: /tmp/dev/scwd/
    1 0
    b 2 1
    a 3 1
    321 4 3
    123 5 3
    123 6 2

*** scfs$> d=/tmp/dev/scwd; python doc/stu/DirectoryWalker-1.py $d startAt=$d/b/bb parentId=2 lastId=6
    -basedir: /tmp/dev/scwd
    -opts: {'lastId': 6, 'startAt': 'b/bb', 'parentId': 2}
    /tmp/dev/scwd 7 2
    b 8 7
    a 9 7
    321 10 9
    123 11 9
    123 12 8
    bb 13 8
    321 14 13
    bbb 15 13
    234 16 15

*** :tmp: scfs$> python doc/stu/DirectoryWalker-1.py /tmp/dev/scwd/a/
    -wd: /tmp/dev/scwd/a/
    1 0
    321 2 1
    123 3 1

    scfs$> python doc/stu/DirectoryWalker-1.py /tmp/dev/scwd/a/ startAt=a parentId=3 lastId=7
    -basedir: /tmp/dev/scwd/a/
    -opts: {'lastId': 7, 'startAt': 'a', 'parentId': 3}
    /tmp/dev/scwd/a 8 3
    321 9 8
    123 10 8



** <<UC2.2>> insert 1 file (non-directory)

** insert UC/s cmp
*** 
   1. add '/tmp/dev/scwd/b' Tbl (of '/tmp/dev/scwd') [[UC2]] for new; [[UC3]] for update!
   2. add '/tmp/dev' Tbl (of '/tmp/dev/scwd') [[UC4]] » re-id Tbl root to longest common: '/tmp/dev'
     - add '/tmp/d' Tbl (of '/tmp/dev/scwd') ([[UC4]]) » re-id Tbl root to longest common: '/tmp' but inside only those 2 branches
     - add '/var/e' Tbl (of '/tmp/dev/scwd') ([[UC4]]) » re-id Tbl root to longest common: '/' :-S but inside only those 2 branches

*** # pathPrefix for deletion
                pathPrefix = server.splitPath(archivedPoint)
                ix = 0
                for i in range(min(len(pathPrefix), len(pathComponents))):
                    if pathPrefix[i] != pathComponents[i]:
                        break
                    ix =+ 1
                pathComponents = pathComponents[i+1:]

*** maybe later could has CD more records about additions: ~
    INSERT INTO "CDs" VALUES(3,'WD_2','/tmp/dev/scwd');
    INSERT INTO "CDs" VALUES(4,'WD_2','/tmp/dev/scwd/b/bb');

**** for now, restrict it to only 1 record:
     INSERT INTO CDs (label, mountPoint)
     SELECT 'WD_2', '/zzz'
     WHERE NOT EXISTS (SELECT 1 FROM CDs WHERE label = 'WD_2');


** <<UC3>> insert -- update existing

** <<UC4>> instert of 'parent' (of existent record)
   --> re-id:
      - old root (fid '1') to '1st' free fid -- &
      - all its childs
   * (& you can do rest as UC2 ?!)


** SETUP see file:~/text/scfs-stu/doc/1st-try.emacs.con.log
*** prerq
   install python-pysqlite2 python-fuse [[file:~/Dropbox/Public/dev%20@web/cdcatfs-0.1.5.tar.gz][cdcatfs]]
   usermod -a -G fuse $USER

*** mount
   install -v -d ~/.scfs ~/mnt/cat1
   python lib/scatfs -d -s -o database=~/.scfs/cat1.cdcat ~/mnt/cat1
#(<) cdcatfs -s -o database=~/.scfs/cat1.cdcat ~/mnt/cat1

*** add content
<<<<<<< HEAD
**** scwd.tgz, <2012-06-27 Wed>
     dev scfs-py$> ls -l "$cache/scwd.tgz"
     -rw-r--r-- 1 blani blani 206 2012-06-27 20:21 /home/blani/Dropbox/B-P/dev text !/dev scfs-py/.test.site/@cache/scwd.tgz

**** front UC
=======
>>>>>>> da1458b3cf38ae223cd6ce81c100bfc7bfb7e888
   cd ~/text/scfs; python lib/scatman add /tmp/dev/scwd WD_UC2 ~/.scfs/cat1.cdcat
#*(<) cdcatman add doc/ CD_1 ~/.scfs/cat1.cdcat
   ls -l ~/mnt/cat1/CD_1
   cdcatman list ~/.scfs/cat1.cdcat
   sqlite3 ~/.scfs/cat1.cdcat .dump

** dev tasks
*** have both cdcat & scat on 1 env; test difference/s



* FORM/s
** .desktop
   (setq ibuffer-filter-groups
   '(("scfs|.py"
   (or
   (filename . "scfs\\|\\.py")))
   ("dev|catfs stu"
   (or
   (filename . "dev\\|catfs")))
   ("^*"
   (name . "^*"))))
